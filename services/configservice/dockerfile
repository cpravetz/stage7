FROM node:20-alpine

WORKDIR /usr/src/app

# Copy package.json files
COPY package*.json ./
COPY shared/package*.json ./shared/
COPY errorhandler/package*.json ./errorhandler/
COPY services/configservice/package*.json ./services/configservice/

# Install dependencies
RUN npm install --omit=dev
RUN cd shared && npm install --omit=dev
RUN cd errorhandler && npm install --omit=dev
RUN cd services/configservice && npm install --omit=dev

# Copy source code
COPY shared ./shared
COPY errorhandler ./errorhandler
COPY services/configservice ./services/configservice

# Build TypeScript
RUN cd shared && npm run build
RUN cd errorhandler && npm run build
RUN cd services/configservice && npm run build

# Create config directory
RUN mkdir -p /usr/src/app/config

# Expose port
EXPOSE 5090

# Start the service
CMD ["node", "services/configservice/dist/ConfigService.js"]
